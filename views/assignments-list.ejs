<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Your Assignments</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background: #f3f5f9; color: #222; margin: 0; padding: 28px; }
    .wrap { max-width: 1100px; margin: 0 auto; background: #fff; padding: 28px; border-radius: 14px; box-shadow: 0 15px 40px rgba(0,0,0,0.06); }
    h1 { margin: 0 0 20px; font-size: 28px; font-weight: 800; }

    .btn-main { padding: 10px 18px; background: #3551a1; color: #fff; border-radius: 8px; text-decoration: none; font-weight: 700; margin-right: 14px; display: inline-block; }
    .btn-secondary { padding: 10px 18px; background: #777; color: #fff; border-radius: 8px; text-decoration: none; font-weight: 700; display: inline-block; }

    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 14px 10px; border-bottom: 1px solid #eee; text-align: left; font-size: 15px; vertical-align: middle; }
    tr:hover { background: #f7faff; cursor: pointer; }

    .status { padding: 6px 12px; border-radius: 14px; font-weight: 700; font-size: 13px; display:inline-block; }
    .s-approved { background: #e9f7ee; color: #d35400; }
    .s-rejected { background: #ffe6e6; color: #c0392b; }
    .s-draft { background: #eef2ff; color: #2b3ea8; }
    .s-submitted { background: #fff3d4; color: #177a3b; }

    .action-btn { padding: 6px 12px; border-radius: 6px; font-weight: 700; margin-right: 8px; border: none; text-decoration: none; display: inline-block; font-size: 14px; }
    .edit-btn { background: #2b7be4; color: #fff; }
    .delete-btn { background: #e74c3c; color: #fff; }

    td.actions { white-space: nowrap; }

    /* modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 2200; }
    .modal-overlay.open { display: flex; }
    .modal { width: 520px; max-width: calc(100% - 32px); background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 18px 50px rgba(0,0,0,0.35); }
    .modal h3 { margin: 0 0 8px; font-size: 18px; }
    .modal p { margin: 6px 0; color: #444; }
    .meta-list { margin-top: 8px; background: #fbfbfb; padding: 10px; border-radius: 8px; font-size: 14px; }
    .meta-list div { margin-bottom: 6px; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top: 12px; }
    .modal .btn-cancel { padding:8px 12px; background:#6c757d;color:#fff;border-radius:8px;border:none;font-weight:700; cursor:pointer; }

    @media (max-width:820px) {
      .wrap { padding: 18px; }
      th, td { padding: 10px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Your Assignments</h1>

    <div style="margin-bottom: 20px;">
      <a href="/student/assignments/upload" class="btn-main">Upload New Assignment</a>
      <a href="/student/dashboard" class="btn-secondary">Back to Dashboard</a>
    </div>

    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Category</th>
          <th>Status</th>
          <th>Uploaded</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (!assignments || assignments.length === 0) { %>
          <tr><td colspan="5">No assignments yet.</td></tr>
        <% } else { %>
          <% assignments.forEach(a => { %>
            <tr onclick="openDetails('<%= a._id %>')">
              <td><%= a.title %></td>
              <td><%= a.category || '-' %></td>
              <td>
                <% if (a.status === 'Approved') { %>
                  <span class="status s-approved">Approved</span>
                <% } else if (a.status === 'Rejected') { %>
                  <span class="status s-rejected">Rejected</span>
                <% } else if (a.status === 'Draft') { %>
                  <span class="status s-draft">Draft</span>
                <% } else { %>
                  <span class="status s-submitted"><%= a.status %></span>
                <% } %>
              </td>

              <td><%= a.createdAt ? new Date(a.createdAt).toLocaleString() : "-" %></td>

              <td class="actions" onclick="event.stopPropagation()">
                <% if (a.status !== 'Submitted') { %>
                  <a href="/student/assignments/<%= a._id %>/edit" class="action-btn edit-btn">Edit</a>
                <% } else { %>
                  <button 
                    class="action-btn edit-btn"
                    onclick="openSubmittedModal(event, '<%= a._id %>', '<%= a.title %>', '<%= a.reviewerName || '-' %>', '<%= a.category || '-' %>', '<%= a.createdAt ? new Date(a.createdAt).toLocaleString() : '-' %>')"
                  >Edit</button>
                <% } %>

                <button class="action-btn delete-btn" onclick="deleteAssignment('<%= a._id %>')">Delete</button>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="submittedModal" class="modal-overlay">
    <div class="modal">
      <h3>Cannot edit â€” assignment already submitted</h3>
      <p>This assignment has already been submitted and cannot be edited.</p>

      <div class="meta-list" id="modalMeta"></div>

      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeSubmittedModal()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    function openDetails(id) {
      window.location.href = "/student/assignments/" + id;
    }

    function deleteAssignment(id) {
      if (!confirm("Are you sure you want to delete this assignment?")) return;
      fetch(`/student/assignments/${id}/delete`, { method: "POST" })
        .then(r => r.json())
        .then(json => {
          if (!json.success) alert(json.message || "Delete failed");
          else location.reload();
        });
    }

    const modalOverlay = document.getElementById('submittedModal');
    const modalMeta = document.getElementById('modalMeta');

    function openSubmittedModal(evt, id, title, reviewer, category, uploaded) {
      evt.stopPropagation();
      modalMeta.innerHTML = `
        <div><strong>Title:</strong> ${title}</div>
        <div><strong>Reviewer:</strong> ${reviewer}</div>
        <div><strong>Category:</strong> ${category}</div>
        <div><strong>Uploaded:</strong> ${uploaded}</div>
      `;
      modalOverlay.classList.add('open');
    }

    function closeSubmittedModal() {
      modalOverlay.classList.remove('open');
    }
  </script>
</body>
</html>
