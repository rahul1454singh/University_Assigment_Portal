<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Your Assignments</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background: #f3f5f9; color: #222; margin: 0; padding: 28px; }
    .wrap { max-width: 1100px; margin: 0 auto; background: #fff; padding: 28px; border-radius: 14px; box-shadow: 0 15px 40px rgba(0,0,0,0.06); }
    h1 { margin: 0 0 20px; font-size: 28px; font-weight: 800; }

    .btn-main { padding: 10px 18px; background: #3551a1; color: #fff; border-radius: 8px; text-decoration: none; font-weight: 700; margin-right: 14px; display: inline-block; }
    .btn-secondary { padding: 10px 18px; background: #777; color: #fff; border-radius: 8px; text-decoration: none; font-weight: 700; display: inline-block; }

    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 14px 10px; border-bottom: 1px solid #eee; text-align: left; font-size: 15px; vertical-align: middle; }
    tr:hover { background: #f7faff; cursor: pointer; }

    .status { padding: 6px 12px; border-radius: 14px; font-weight: 700; font-size: 13px; display:inline-block; }
    .s-approved { background: #e9f7ee; color: #d35400; }
    .s-rejected { background: #ffe6e6; color: #c0392b; }
    .s-draft { background: #eef2ff; color: #2b3ea8; }
    .s-submitted { background: #fff3d4; color: #177a3b; }

    .action-btn { padding: 6px 12px; border-radius: 6px; font-weight: 700; margin-right: 8px; border: none; text-decoration: none; display: inline-block; font-size: 14px; }
    .view-file-btn { background: #6c757d; color: #fff; }
    .edit-btn { background: #2b7be4; color: #fff; }
    .delete-btn { background: #e74c3c; color: #fff; }

    /* prevent actions area triggering row click */
    td.actions { white-space: nowrap; }

    /* modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 2200; }
    .modal-overlay.open { display: flex; }
    .modal { width: 520px; max-width: calc(100% - 32px); background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 18px 50px rgba(0,0,0,0.35); }
    .modal h3 { margin: 0 0 8px; font-size: 18px; }
    .modal p { margin: 6px 0; color: #444; }
    .meta-list { margin-top: 8px; background: #fbfbfb; padding: 10px; border-radius: 8px; font-size: 14px; }
    .meta-list div { margin-bottom: 6px; }
    .modal-actions { display:flex; gap:8px; justify-content:flex-end; margin-top: 12px; }
    .modal .btn-cancel { padding:8px 12px; background:#6c757d;color:#fff;border-radius:8px;border:none;font-weight:700; cursor:pointer; }

    @media (max-width:820px) {
      .wrap { padding: 18px; }
      th, td { padding: 10px; font-size: 14px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Your Assignments</h1>

    <div style="margin-bottom: 20px;">
      <a href="/student/assignments/upload" class="btn-main">Upload New Assignment</a>
      <a href="/student/dashboard" class="btn-secondary">Back to Dashboard</a>
    </div>

    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Category</th>
          <th>Status</th>
          <th>File</th>
          <th>Uploaded</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if (!assignments || assignments.length === 0) { %>
          <tr><td colspan="6">No assignments yet.</td></tr>
        <% } else { %>
          <% assignments.forEach(a => { %>
            <tr onclick="openDetails('<%= a._id %>')">
              <td><%= a.title %></td>
              <td><%= a.category || '-' %></td>
              <td>
                <% if (a.status === 'Approved') { %>
                  <span class="status s-approved">Approved</span>
                <% } else if (a.status === 'Rejected') { %>
                  <span class="status s-rejected">Rejected</span>
                <% } else if (a.status === 'Draft') { %>
                  <span class="status s-draft">Draft</span>
                <% } else { %>
                  <span class="status s-submitted"><%= a.status %></span>
                <% } %>
              </td>

              <td>
                <% if (a.file && a.file.path) { %>
                  <a href="<%= a.file.path %>" target="_blank" class="action-btn view-file-btn" onclick="event.stopPropagation()">View</a>
                <% } else { %>
                  -
                <% } %>
              </td>

              <td><%= a.createdAt ? new Date(a.createdAt).toLocaleString() : "-" %></td>

              <td class="actions" onclick="event.stopPropagation()">
                <% if (a.status !== 'Submitted') { %>
                  <!-- if not submitted -> direct edit link -->
                  <a href="/student/assignments/<%= a._id %>/edit" class="action-btn edit-btn">Edit</a>
                <% } else { %>
                  <!-- if submitted -> open modal with details (stays on list) -->
                  <!-- Passing title as a parameter to avoid relying on DOM traversal -->
                  <button 
                    class="action-btn edit-btn" 
                    onclick="openSubmittedModal(event, '<%= a._id %>', '<%= (a.title || '').replace(/'/g, '\\\'').replace(/\\/g, '\\\\') %>', '<%= (a.file && a.file.originalname) ? a.file.originalname.replace(/'/g, '\\\'').replace(/\\/g, '\\\\') : '' %>', '<%= (a.reviewerName ? a.reviewerName : '-') .replace(/'/g, '\\\'').replace(/\\/g, '\\\\') %>', '<%= (a.category ? a.category : '-') .replace(/'/g, '\\\'').replace(/\\/g, '\\\\') %>', '<%= a.createdAt ? new Date(a.createdAt).toLocaleString() : '-' %>')"
                  >Edit</button>
                <% } %>

                <button class="action-btn delete-btn" onclick="deleteAssignment('<%= a._id %>')">Delete</button>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- Modal shown when Edit clicked for already-submitted assignments -->
  <div id="submittedModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Cannot edit â€” assignment already submitted</h3>
      <p>This assignment has already been submitted and cannot be edited or modified. See file details below:</p>

      <div class="meta-list" id="modalMeta">
        <!-- details populated by JS -->
      </div>

      <div class="modal-actions">
        <button id="modalCancel" class="btn-cancel" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    function openDetails(id) {
      window.location.href = "/student/assignments/" + id;
    }

    function deleteAssignment(id) {
      if (!confirm("Are you sure you want to delete this assignment?")) return;
      fetch(`/student/assignments/${id}/delete`, { method: "POST" })
        .then(r => r.json())
        .then(json => {
          if (!json.success) return alert(json.message || "Delete failed");
          location.reload();
        })
        .catch(() => alert("Error deleting assignment"));
    }

    // modal logic
    const modalOverlay = document.getElementById('submittedModal');
    const modalMeta = document.getElementById('modalMeta');
    const modalCancel = document.getElementById('modalCancel');

    // openSubmittedModal now accepts (evt, id, title, filename, reviewerName, category, uploaded)
    function openSubmittedModal(evt, id, title, filename, reviewerName, category, uploaded) {
      // prevent row navigation
      evt.stopPropagation();
      evt.preventDefault();

      title = title || '-';
      filename = filename || '-';
      reviewerName = reviewerName || '-';
      category = category || '-';
      uploaded = uploaded || '-';

      // Populate modal meta
      modalMeta.innerHTML = `
        <div><strong>Title:</strong> ${escapeHtml(title)}</div>
        <div><strong>File:</strong> ${escapeHtml(filename)}</div>
        <div><strong>Reviewer:</strong> ${escapeHtml(reviewerName)}</div>
        <div><strong>Category:</strong> ${escapeHtml(category)}</div>
        <div><strong>Uploaded:</strong> ${escapeHtml(uploaded)}</div>
      `;

      // show modal
      modalOverlay.classList.add('open');
      modalOverlay.setAttribute('aria-hidden', 'false');

      // focus cancel for accessibility
      modalCancel.focus();
    }

    // close modal when cancel clicked (do not navigate away)
    modalCancel.addEventListener('click', () => {
      closeSubmittedModal();
    });

    function closeSubmittedModal() {
      modalOverlay.classList.remove('open');
      modalOverlay.setAttribute('aria-hidden', 'true');
      // return focus to document body (or you could try to focus the previous button)
      document.activeElement && document.activeElement.blur();
    }

    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // close modal if clicking outside or pressing Esc
    modalOverlay.addEventListener('click', (e) => {
      // if clicked the overlay (not the modal box)
      if (e.target === modalOverlay) {
        closeSubmittedModal();
      }
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modalOverlay.classList.contains('open')) {
        closeSubmittedModal();
      }
    });
  </script>
</body>
</html>
